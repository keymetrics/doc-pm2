<!DOCTYPE html>

<html class="monitoring-page">

  <head>
    <meta charset="UTF-8">
    <title>Document</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="Description">
    <!-- <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96"> -->
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link href="/doc-pm2/assets/img/favicon-96x96.png" rel="icon" sizes="96x96" type="image/png">
    <link rel=“prefetch” href="https://fonts.googleapis.com/css?family=Roboto:400,500">
    <link rel="stylesheet" href="/doc-pm2/assets/css/styles.css">
    <link rel="stylesheet" href="/doc-pm2/assets/css/normalize.css">
    <link rel="stylesheet" href="/doc-pm2/assets/css/bundle.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css">
    <link rel="stylesheet" href="//unpkg.com/gitalk/dist/gitalk.css">
</head>
  <body class="test ready sticky">
      <div class="section header-section">
    <div class=" header-container">
        <div class="PM2_logo_wrapper">
            <a class="logo-container link">
                <div class="PM2_logo"></div>
            </a>
        </div>
        <div class="PM2_search search-wrapper">
            <span class="algolia-autocomplete" style="position: relative; display: inline-block; direction: ltr;"><input class="search_input ds-input" placeholder="Search documentation..." autocomplete="off" spellcheck="false" role="combobox" aria-autocomplete="list" aria-expanded="false" aria-owns="algolia-autocomplete-listbox-0" dir="auto" style="position: relative; vertical-align: top;"><pre aria-hidden="true" style="position: absolute; visibility: hidden; white-space: pre; font-family: Saira, sans-serif; font-size: 18px; font-style: normal; font-variant: normal; font-weight: 400; word-spacing: 0px; letter-spacing: normal; text-indent: 0px; text-rendering: auto; text-transform: none;"></pre><span class="ds-dropdown-menu" role="listbox" id="algolia-autocomplete-listbox-0" style="position: absolute; top: 100%; z-index: 100; display: none; left: 0px; right: auto;"><div class="ds-dataset-1"></div></span></span>
            <div class="PM2_search_icon"><i class="fas fa-search"></i></div>
            <div id="hits" class="algolia-results">
                <!-- Hits widget will appear here -->
            </div>
        </div>
    </div>
</div>
      <main>
          <aside class="sidebar">
    <div class="sidebar_2_wrapper">
        <div class="sidebar_2">
            <a href="/doc-pm2/runtime/overview" data-page="runtime-page">
                <div class="sidebar_2_item sidebar_2_item_runtime">
                    <img class="sidebar_2_item__image" src="/doc-pm2/assets/static/pm2-logo-r.png">
                    <div class="sidebar_2_item__text">Runtime</div>
                </div>
            </a>
            <a href="/doc-pm2/monitoring/overview" data-page="monitoring-page">
                <div class="sidebar_2_item sidebar_2_item_monitoring">
                    <img class="sidebar_2_item__image" src="/doc-pm2/assets/static/pm2-logo-m.png">
                    <div class="sidebar_2_item__text">Monitoring</div>
                </div>
            </a>
            <a href="/doc-pm2/enterprise/overview" data-page="enterprise-page">
                <div class="sidebar_2_item sidebar_2_item_enterprise">
                    <img class="sidebar_2_item__image" src="/doc-pm2/assets/static/pm2-logo-e.png">
                    <div class="sidebar_2_item__text">Enterprise</div>
                </div>
            </a>
        </div>
        <div class="main_content">
        </div>
    </div>
    <div class="sidebar-nav">

    <ul id="acc">
    
    
    
    
        <li class="">
            <a href="/doc-pm2/monitoring/overview/">Overview</a>
            
        </li>
    
    
    
        <li class="">
            <a href="/doc-pm2/monitoring/quick-start/">Quick Start</a>
            
        </li>
    
    
    
        <li class="active">
            <a href="/doc-pm2/monitoring/guide/">Guide</a>
            
                
                    <ul>
                        
                        
                        <li class=""><a href="/doc-pm2/monitoring/guide/installation/">Installation</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/monitoring/guide/configuration/">Configuration</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/monitoring/guide/notifications/">Notification</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/monitoring/guide/issue-dashboard/">Issue dashboard</a></li>
                        
                        
                        <li class="active"><a href="/doc-pm2/monitoring/guide/transaction-tracing/">Transaction tracing</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/monitoring/guide/memory-cpu-profiling/">Memory & CPU Profiling</a></li>
                        
                    </ul>
                
            
        </li>
    
    
    
        <li class="">
            <a href="/doc-pm2/monitoring/integration/">Integration</a>
            
                
            
        </li>
    
    
    
        <li class="">
            <a href="/doc-pm2/monitoring/reference/">Reference</a>
            
        </li>
    
    </ul>

    </div>
</aside>
          <section class="content">
              <div class="markdown-section gettings_started_block topBlock">
    <p style="display: initial;">Getting started with PM2<span class="runtime_block gettings_started_block_span">Runtime</span><span class="monitoring_block gettings_started_block_span">Monitoring</span><span class="enterprise_block gettings_started_block_span">Enterprise</span></p>
</div>
              <article id="main" class="markdown-section">
                  <div class="edit-page">
  <a rel="noopener" class="edit-page__text" target="_blank" href="http://github.com/keymetrics/doc-pm2/blob/master/_i18n/en/monitoring/guide/transaction-tracing.md">Edit Page</a>
</div>
                   <h1 id="transaction-tracing">Transaction tracing</h1>

<p>The transaction tracing is useful to troubleshoot performance issues and get detailed low-level insight of how your app is working.</p>

<p>Slow HTTP calls are identified and the database and external calls are aggregated to understand why.</p>

<p><img src="/doc-pm2/assets/img/monitoring/tracing.png" alt="transaction tracing" /></p>

<hr />

<h2 id="enable-the-transaction-tracing">Enable the transaction tracing</h2>

<p>The transaction tracing is disabled by default. On big infrastructure, you should only use the transaction tracing for a few days to collect informations and then disable it because there is no sampling and all requests are treated.</p>

<p>You’ll have to wait 10min to let pm2 collects enough data.</p>

<h3 id="pmx">PMX</h3>

<p>Add <code class="highlighter-rouge">trace: true</code> at the pmx initialisation.</p>

<h3 id="terminal">Terminal</h3>

<p>When the transaction tracing is enabled, you’ll see a clock on the side of the process in the process list (<code class="highlighter-rouge">pm2 ls</code>).</p>

<p>Enable with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pm2 reload &lt;app_name&gt; <span class="nt">--trace</span>
</code></pre></div></div>

<p>Disable with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pm2 reload &lt;app_name&gt; <span class="nt">--disable-trace</span>
</code></pre></div></div>

<hr />

<h2 id="advanced-options">Advanced options</h2>

<p>You must use the pmx initialisation to customize your transaction tracing.</p>

<p><code class="highlighter-rouge">--trace</code> enable transaction tracing with default settings, so run <code class="highlighter-rouge">--disable-trace</code> before using advanced options.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">{</span>
    <span class="c1">// Log levels: 0-disabled, 1-error, 2-warn, 3-info, 4-debug</span>
    <span class="nl">logLevel</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>

    <span class="c1">// Ignore request based on matching string/regex for each field</span>
    <span class="c1">// Only one value need to match for the request to be ignored.</span>
    <span class="c1">// Example :</span>
    <span class="c1">// ignoreFilter: { path: [/v1/, '/'], ip: [/127.0.0.1/, '::1'] }</span>
    <span class="c1">// will ignore request that contains v1 in their path or the index</span>
    <span class="c1">// it will ignore request that has been made by localhost</span>
    <span class="nx">ignoreFilter</span><span class="p">:</span> <span class="p">{</span>
      <span class="s1">'path'</span><span class="p">:</span> <span class="p">[],</span>
      <span class="s1">'method'</span><span class="p">:</span> <span class="p">[],</span>
      <span class="s1">'ip'</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">},</span>

    <span class="c1">// An upper bound on the number of traces to gather each second. If set to 0,</span>
    <span class="c1">// sampling is disabled and all transactions are recorded. Sampling rates greater</span>
    <span class="c1">// than 1000 are not supported and will result in at most 1000 samples per</span>
    <span class="c1">// second.</span>
    <span class="nx">samplingRate</span><span class="p">:</span> <span class="mi">0</span>
 <span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="transaction-tracing-dashboard">Transaction tracing dashboard</h2>

<h3 id="latency-graph">Latency graph</h3>

<p>Under the graph you can select which values you want drawn on the graph:</p>
<ul>
  <li>The <a href="https://en.wikipedia.org/wiki/Median">median</a> of the application tells you what an ordinary user can expect as a response time.</li>
  <li>P95 and P99 curves lets you explore the evolution of the slowest latencies of your application.</li>
  <li>The database latencies shows you how much time they consume in a standard request.</li>
</ul>

<h3 id="transaction-list">Transaction list</h3>

<p>You can sort the recorded path of your app according to:</p>

<ul>
  <li>Most time consuming: Total time spent in this route for the whole application</li>
  <li>Slowest routes: Which routes take the most time</li>
  <li>Number of calls: how many calls are made to every route</li>
</ul>

<h3 id="transaction-details-and-variances">Transaction details and Variances</h3>

<p>Some transactions have the same path but respond differently: a forbidden access on a route can return a 403 and be executed differently than usual. We call those <strong>variances</strong>: for each path we log up 5 most used variances that you can examine here.</p>

<p>Let’s examine a specific variance:</p>
<ul>
  <li>median, slowest and fastest call response time</li>
  <li>Metadata about the call</li>
  <li>List of registered subcalls. If no call to an external <a href="http://docs.keymetrics.io/docs/pages/tracing/#under-the-hood">entity</a> is made, nothing will appear here. The call display and information depends on the stack logged. For databases, you will for example see the database call made.</li>
</ul>

<p>You can then click on another <strong>variance</strong> to examine why and how the behaviour was different.</p>

<hr />

<h2 id="under-the-hood">Under the hood</h2>

<p>PMX will wrap below modules if they exist in your application :</p>
<ul>
  <li><code class="highlighter-rouge">express</code> version 4</li>
  <li><code class="highlighter-rouge">hapi</code> versions 8 - 13</li>
  <li><code class="highlighter-rouge">restify</code> versions 3 - 4</li>
  <li><code class="highlighter-rouge">koa</code> version v1.x</li>
  <li>Outbound HTTP requests using <code class="highlighter-rouge">http</code> core module</li>
  <li><code class="highlighter-rouge">mongodb-core</code> version 1 (used by mongoose)</li>
  <li><code class="highlighter-rouge">redis</code> versions 0.12 - 2</li>
  <li><code class="highlighter-rouge">mysql</code> version ^2.9</li>
  <li><code class="highlighter-rouge">pg</code> version ^6.x</li>
</ul>

<p>Then record all requests made or received by them then sended to PM2 to be aggregated.
The impact on performance should be low since there is no heavy logic done in your process except wrap modules and sending data.</p>

<hr />

<h2 id="things-to-know">Things to know</h2>

<ul>
  <li>When received by PM2, transactions are aggregated depending on their path (so without the query), for example :
    <ul>
      <li><code class="highlighter-rouge">/api/users/1</code> and <code class="highlighter-rouge">/api/users/2</code> will be aggregated together because PM2 detected the <code class="highlighter-rouge">1</code> and <code class="highlighter-rouge">2</code> has identifier</li>
      <li><code class="highlighter-rouge">/api/users/search</code> and <code class="highlighter-rouge">/api/users/1</code> will not be aggregated together because <code class="highlighter-rouge">search</code> isnt a identifier</li>
    </ul>
  </li>
  <li>PM2 detect identifier with multiples regex :
    <ul>
      <li>UUID v1/v4 with or without dash (<code class="highlighter-rouge">/[0-9a-f]{8}-[0-9a-f]{4}-[14][0-9a-f]{3}-[0-9a-f]{4}-[0-9a-f]{12}|[0-9a-f]{12}[14][0-9a-f]{19}/</code>)</li>
      <li>any number (<code class="highlighter-rouge">/\d+/</code>)</li>
      <li>suit of number and letter (<code class="highlighter-rouge">/[0-9]+[a-z]+|[a-z]+[0-9]+/</code>) : this one is used by mongo for document id</li>
      <li>most SEO optimized webpages (articles, blog posts…): <code class="highlighter-rouge">/((?:[0-9a-zA-Z]+[@\-_.][0-9a-zA-Z]+|[0-9a-zA-Z]+[@\-_.]|[@\-_.][0-9a-zA-Z]+)+)/</code></li>
    </ul>
  </li>
  <li>This feature has some known problems with other modules :
    <ul>
      <li><code class="highlighter-rouge">request-promise</code>: clears the node cache and requires a new clean version of the <code class="highlighter-rouge">http</code> module. To solve this, require <code class="highlighter-rouge">http</code> again after requiring <code class="highlighter-rouge">request-promise</code> to get the correctly wrapped <code class="highlighter-rouge">http</code> module.</li>
      <li><code class="highlighter-rouge">node-newrelic</code>: works as we do, so you might encounter problems with it.</li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="next-steps">Next steps</h2>

<p><a href="/doc-pm2/monitoring/guide/profiling.md">Profiling</a></p>

<hr />

<h2 id="questions-">Questions ?</h2>

<p>We are always happy to help with questions you might have. Search our documentation or check out answers to common questions. You can also post questions or comments to our community forum. You can also have a look at our support github https://github.com/keymetrics/keymetrics-support</p>


              </article>
              <footer class="markdown-section copyright">
    <p>© 2018 Keymetrics</p>
    <ul id="footer">
        <li><a href="javascript:void(0);">Terms of Use</a></li>
        <li><a href="javascript:void(0);">Privacy Policy</a></li>

        <!-- Adds links to other languages on the post -->
        
          
        
          
            
              <li><p class="footer-list">Language: <a href="/doc-pm2/ch/monitoring/guide/transaction-tracing/" >Chinese (中文版)</a></p></li>
            

            

            

          
        
    </ul>
  </footer>



          </section>

      </main>
  </body>
  <script src="https://unpkg.com/clipboard@2.0.0/dist/clipboard.min.js" type="text/javascript"></script>
  <script src="https://unpkg.com/prismjs@1.13.0/prism.js" type="text/javascript"></script>
  <script src="https://unpkg.com/prismjs/components/prism-bash.min.js" type="text/javascript"></script>
  <script src="https://unpkg.com/prismjs/components/prism-markdown.min.js" type="text/javascript"></script>
  <script src="https://unpkg.com/prismjs/components/prism-nginx.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.10.0/js/md5.min.js" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="/doc-pm2/assets/js/prism-clipboard.js" type="text/javascript"></script>
  <!-- <script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script> -->
  <!-- <script src="/doc-pm2/assets/js/gittalk.js"></script> -->
  <script src="/doc-pm2/assets/js/keymetrics-plugins.js" type="text/javascript"></script>
  <script src="/doc-pm2/assets/js/additional.js" type="text/javascript"></script>
</html>

