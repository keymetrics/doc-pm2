<!DOCTYPE html>

<html class="runtime-page">

  <head>
    <meta charset="UTF-8">
    <title>Document</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="Description">
    <!-- <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96"> -->
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link href="/doc-pm2/assets/img/favicon-96x96.png" rel="icon" sizes="96x96" type="image/png">
    <link rel=“prefetch” href="https://fonts.googleapis.com/css?family=Roboto:400,500">
    <link rel="stylesheet" href="/doc-pm2/assets/css/styles.css">
    <link rel="stylesheet" href="/doc-pm2/assets/css/normalize.css">
    <link rel="stylesheet" href="/doc-pm2/assets/css/bundle.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css">
    <link rel="stylesheet" href="//unpkg.com/gitalk/dist/gitalk.css">
</head>
  <body class="test ready sticky">
      <div class="section header-section">
    <div class=" header-container">
        <div class="PM2_logo_wrapper">
            <a class="logo-container link">
                <div class="PM2_logo"></div>
            </a>
        </div>
        <div class="PM2_search search-wrapper">
            <span class="algolia-autocomplete" style="position: relative; display: inline-block; direction: ltr;"><input class="search_input ds-input" placeholder="Search documentation..." autocomplete="off" spellcheck="false" role="combobox" aria-autocomplete="list" aria-expanded="false" aria-owns="algolia-autocomplete-listbox-0" dir="auto" style="position: relative; vertical-align: top;"><pre aria-hidden="true" style="position: absolute; visibility: hidden; white-space: pre; font-family: Saira, sans-serif; font-size: 18px; font-style: normal; font-variant: normal; font-weight: 400; word-spacing: 0px; letter-spacing: normal; text-indent: 0px; text-rendering: auto; text-transform: none;"></pre><span class="ds-dropdown-menu" role="listbox" id="algolia-autocomplete-listbox-0" style="position: absolute; top: 100%; z-index: 100; display: none; left: 0px; right: auto;"><div class="ds-dataset-1"></div></span></span>
            <div class="PM2_search_icon"><i class="fas fa-search"></i></div>
            <div id="hits" class="algolia-results">
                <!-- Hits widget will appear here -->
            </div>
        </div>
    </div>
</div>
      <main>
          <aside class="sidebar">
    <div class="sidebar_2_wrapper">
        <div class="sidebar_2">
            <a href="/doc-pm2/runtime/overview" data-page="runtime-page">
                <div class="sidebar_2_item sidebar_2_item_runtime">
                    <img class="sidebar_2_item__image" src="/doc-pm2/assets/static/pm2-logo-r.png">
                    <div class="sidebar_2_item__text">Runtime</div>
                </div>
            </a>
            <a href="/doc-pm2/monitoring/overview" data-page="monitoring-page">
                <div class="sidebar_2_item sidebar_2_item_monitoring">
                    <img class="sidebar_2_item__image" src="/doc-pm2/assets/static/pm2-logo-m.png">
                    <div class="sidebar_2_item__text">Monitoring</div>
                </div>
            </a>
            <a href="/doc-pm2/enterprise/overview" data-page="enterprise-page">
                <div class="sidebar_2_item sidebar_2_item_enterprise">
                    <img class="sidebar_2_item__image" src="/doc-pm2/assets/static/pm2-logo-e.png">
                    <div class="sidebar_2_item__text">Enterprise</div>
                </div>
            </a>
        </div>
        <div class="main_content">
        </div>
    </div>
    <div class="sidebar-nav">

    <ul id="acc">
    
    
    
    
        <li class="">
            <a href="/doc-pm2/runtime/overview/">Overview</a>
            
        </li>
    
    
    
        <li class="">
            <a href="/doc-pm2/runtime/quick-start/">Quick Start</a>
            
        </li>
    
    
    
        <li class="active">
            <a href="/doc-pm2/runtime/guide/">Guide</a>
            
                
                    <ul>
                        
                        
                        <li class=""><a href="/doc-pm2/runtime/guide/installation/">Installation</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/runtime/guide/ecosystem-file/">Ecosystem File</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/runtime/guide/process-management/">Process Management</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/runtime/guide/log-management/">Log Management</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/runtime/guide/startup-hook/">Startup Hook</a></li>
                        
                        
                        <li class="active"><a href="/doc-pm2/runtime/guide/load-balancing/">Load-Balancing (cluster mode)</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/runtime/guide/development-tools/">Development Tools</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/runtime/guide/easy-deploy-with-ssh/">Easy Deploy with SSH</a></li>
                        
                    </ul>
                
            
        </li>
    
    
    
        <li class="">
            <a href="/doc-pm2/runtime/production-best-practices/">Best Practices</a>
            
                
            
        </li>
    
    
    
        <li class="">
            <a href="/doc-pm2/runtime/integration/">Integration</a>
            
                
            
        </li>
    
    
    
        <li class="">
            <a href="/doc-pm2/runtime/references/">References</a>
            
                
            
        </li>
    
    </ul>

    </div>
</aside>
          <section class="content">
              <div class="markdown-section gettings_started_block topBlock">
    <p style="display: initial;">Getting started with PM2<span class="runtime_block gettings_started_block_span">Runtime</span><span class="monitoring_block gettings_started_block_span">Monitoring</span><span class="enterprise_block gettings_started_block_span">Enterprise</span></p>
</div>
              <article id="main" class="markdown-section">
                  <div class="edit-page">
  <a rel="noopener" class="edit-page__text" target="_blank" href="http://github.com/keymetrics/doc-pm2/blob/master/_i18n/en/runtime/guide/load-balancing.md">Edit Page</a>
</div>
                   
<h1 id="load-balancing-cluster-mode">Load-Balancing (cluster mode)</h1>

<p>The built-in load-balancer provides networked Node.js applications (http(s)/tcp/udp server) to be scaled accross all CPUs available, without any code modifications.</p>

<p><img src="/doc-pm2/assets/img/runtime/cluster-mode.png" alt="scale across all cpu's available" /></p>

<hr />

<h2 id="usage">Usage</h2>

<p>To enable the cluster mode, just pass the <code class="highlighter-rouge">-i &lt;number-instances&gt;</code> option:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pm2 start app.js <span class="nt">-i</span> max
</code></pre></div></div>

<p><code class="highlighter-rouge">max</code> means that PM2 will auto detect the number of available CPUs and run as many processes as possible</p>

<p>Or via your ecosystem file (ecosystem.config.js):</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">apps</span><span class="p">:</span> <span class="p">[{</span>
    <span class="na">script</span><span class="p">:</span> <span class="s2">"app.js"</span><span class="p">,</span>
    <span class="na">instances</span><span class="p">:</span> <span class="s2">"max"</span><span class="p">,</span>
  <span class="p">}]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <em>instances</em> option can be:</p>
<ul>
  <li>an Integer. This spreads the app across a specific number of clusters.</li>
  <li>the String ‘max’. This spreads the app across all CPU cores.</li>
</ul>

<p>?&gt; You can also use a negative integer. If 4 cores, <code class="highlighter-rouge">pm2 start -i -1</code> will spread 3 clusters (max - integer).</p>

<hr />

<h2 id="stateless-application">Stateless Application</h2>

<p>In the context of clustering, you first need to be sure that your application has no internal state.</p>

<p>An internal state is typically some local data stored into its processes. It can be an array of websocket connections or a local session-memory for example. Use Redis or other databases instead to share the states between processes.</p>

<p>Follow our <a href="/doc-pm2/runtime/production-best-practices/stateless-application/">tutorial</a> to make your app stateless.</p>

<hr />

<h2 id="0-second-downtime-reload">0 second downtime reload</h2>

<p>When you use <code class="highlighter-rouge">restart</code>, pm2 kills and restarts the process so there is a short period of time during which the service is unavailable.</p>

<p>With reload, pm2 restarts all instances one by one always kepping at least one process running:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pm2 reload &lt;app_name&gt;
</code></pre></div></div>

<p>Or:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pm2 reload ecosystem.config.js
pm2 reload ecosystem.config.js <span class="nt">--only</span> app
</code></pre></div></div>

<p>If the reload system hasn’t managed to reload your application, a timeout will fallback to a classic restart.</p>

<hr />

<h2 id="graceful-start--shutdown">Graceful Start &amp; Shutdown</h2>

<p>To be sure that all requests are properly handled in a reload, you need to be sure that your application shutdown, not leaving unanswered requests.</p>

<p>A graceful shutdown makes sure to handle all remaining queries before exiting the application and closes all external connections.</p>

<p>Get help to setup graceful shutdown with our <a href="/doc-pm2/runtime/production-best-practices/graceful-shutdown/">tutorial</a>.</p>

<hr />

<h2 id="cluster-environment-variable">Cluster environment variable</h2>

<p>The <code class="highlighter-rouge">NODE_APP_INSTANCE</code> environment variable is used to make a difference between cluster.</p>

<p>For example, if you want to run a cronjob only on one cluster, you can check if <code class="highlighter-rouge">process.env.NODE_APP_INSTANCE === 0</code>.</p>

<p>This variable can be renamed in the ecosystem file:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">apps</span><span class="p">:</span> <span class="p">[{</span>
    <span class="na">name</span><span class="p">:</span> <span class="s2">"app"</span><span class="p">,</span>
    <span class="na">script</span><span class="p">:</span> <span class="s2">"./app.js"</span><span class="p">,</span>
    <span class="na">instance_var</span><span class="p">:</span> <span class="s2">"INSTANCE_ID"</span><span class="p">,</span>
  <span class="p">}]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>?&gt; This is useful with the <code class="highlighter-rouge">node-config</code> package where name conflicts have been reported, check the <a href="https://github.com/Unitech/pm2/issues/2045">issue</a>.</p>

<hr />

<h2 id="next-steps">Next steps</h2>

<p><a href="/doc-pm2/runtime/guide/development-tools/">Development tools</a></p>

<hr />

<h2 id="questions-">Questions ?</h2>

<p>We are always happy to help with questions you might have. Search our documentation or check out answers to common questions. You can also post questions or comments to our community forum.</p>


              </article>
              <footer class="markdown-section copyright">
    <p>© 2018 Keymetrics</p>
    <ul id="footer">
        <li><a href="javascript:void(0);">Terms of Use</a></li>
        <li><a href="javascript:void(0);">Privacy Policy</a></li>

        <!-- Adds links to other languages on the post -->
        
          
        
          
            
              <li><p class="footer-list">Language: <a href="/doc-pm2/ch/runtime/guide/load-balancing/" >Chinese (中文版)</a></p></li>
            

            

            

          
        
    </ul>
  </footer>



          </section>

      </main>
  </body>
  <script src="https://unpkg.com/clipboard@2.0.0/dist/clipboard.min.js" type="text/javascript"></script>
  <script src="https://unpkg.com/prismjs@1.13.0/prism.js" type="text/javascript"></script>
  <script src="https://unpkg.com/prismjs/components/prism-bash.min.js" type="text/javascript"></script>
  <script src="https://unpkg.com/prismjs/components/prism-markdown.min.js" type="text/javascript"></script>
  <script src="https://unpkg.com/prismjs/components/prism-nginx.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.10.0/js/md5.min.js" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="/doc-pm2/assets/js/prism-clipboard.js" type="text/javascript"></script>
  <!-- <script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script> -->
  <!-- <script src="/doc-pm2/assets/js/gittalk.js"></script> -->
  <script src="/doc-pm2/assets/js/keymetrics-plugins.js" type="text/javascript"></script>
  <script src="/doc-pm2/assets/js/additional.js" type="text/javascript"></script>
</html>

