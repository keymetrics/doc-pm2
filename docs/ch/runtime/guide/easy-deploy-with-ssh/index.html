<!DOCTYPE html>

<html class="runtime-page">

  <head>
    <meta charset="UTF-8">
    <title>Document</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="Description">
    <!-- <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96"> -->
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link href="/doc-pm2/assets/img/favicon-96x96.png" rel="icon" sizes="96x96" type="image/png">
    <link rel=“prefetch” href="https://fonts.googleapis.com/css?family=Roboto:400,500">
    <link rel="stylesheet" href="/doc-pm2/assets/css/styles.css">
    <link rel="stylesheet" href="/doc-pm2/assets/css/normalize.css">
    <link rel="stylesheet" href="/doc-pm2/assets/css/bundle.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css">
    <link rel="stylesheet" href="//unpkg.com/gitalk/dist/gitalk.css">
</head>
  <body class="test ready sticky">
      <div class="section header-section">
    <div class=" header-container">
        <div class="PM2_logo_wrapper">
            <a class="logo-container link">
                <div class="PM2_logo"></div>
            </a>
        </div>
        <div class="PM2_search search-wrapper">
            <span class="algolia-autocomplete" style="position: relative; display: inline-block; direction: ltr;"><input class="search_input ds-input" placeholder="Search documentation..." autocomplete="off" spellcheck="false" role="combobox" aria-autocomplete="list" aria-expanded="false" aria-owns="algolia-autocomplete-listbox-0" dir="auto" style="position: relative; vertical-align: top;"><pre aria-hidden="true" style="position: absolute; visibility: hidden; white-space: pre; font-family: Saira, sans-serif; font-size: 18px; font-style: normal; font-variant: normal; font-weight: 400; word-spacing: 0px; letter-spacing: normal; text-indent: 0px; text-rendering: auto; text-transform: none;"></pre><span class="ds-dropdown-menu" role="listbox" id="algolia-autocomplete-listbox-0" style="position: absolute; top: 100%; z-index: 100; display: none; left: 0px; right: auto;"><div class="ds-dataset-1"></div></span></span>
            <div class="PM2_search_icon"><i class="fas fa-search"></i></div>
            <div id="hits" class="algolia-results">
                <!-- Hits widget will appear here -->
            </div>
        </div>
    </div>
</div>
      <main>
          <aside class="sidebar">
    <div class="sidebar_2_wrapper">
        <div class="sidebar_2">
            <a href="/doc-pm2/ch/runtime/overview" data-page="runtime-page">
                <div class="sidebar_2_item sidebar_2_item_runtime">
                    <img class="sidebar_2_item__image" src="/doc-pm2/assets/static/pm2-logo-r.png">
                    <div class="sidebar_2_item__text">Runtime</div>
                </div>
            </a>
            <a href="/doc-pm2/ch/monitoring/overview" data-page="monitoring-page">
                <div class="sidebar_2_item sidebar_2_item_monitoring">
                    <img class="sidebar_2_item__image" src="/doc-pm2/assets/static/pm2-logo-m.png">
                    <div class="sidebar_2_item__text">Monitoring</div>
                </div>
            </a>
            <a href="/doc-pm2/ch/enterprise/overview" data-page="enterprise-page">
                <div class="sidebar_2_item sidebar_2_item_enterprise">
                    <img class="sidebar_2_item__image" src="/doc-pm2/assets/static/pm2-logo-e.png">
                    <div class="sidebar_2_item__text">Enterprise</div>
                </div>
            </a>
        </div>
        <div class="main_content">
        </div>
    </div>
    <div class="sidebar-nav">

    <ul id="acc">
    
    
    
    
        <li class="">
            <a href="/doc-pm2/ch/runtime/overview/">Overview</a>
            
        </li>
    
    
    
        <li class="">
            <a href="/doc-pm2/ch/runtime/quick-start/">Quick Start</a>
            
        </li>
    
    
    
        <li class="active">
            <a href="/doc-pm2/ch/runtime/guide/">Guide</a>
            
                
                    <ul>
                        
                        
                        <li class=""><a href="/doc-pm2/ch/runtime/guide/installation/">Installation</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/ch/runtime/guide/ecosystem-file/">Ecosystem File</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/ch/runtime/guide/process-management/">Process Management</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/ch/runtime/guide/log-management/">Log Management</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/ch/runtime/guide/startup-hook/">Startup Hook</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/ch/runtime/guide/load-balancing/">Load-Balancing (cluster mode)</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/ch/runtime/guide/development-tools/">Development Tools</a></li>
                        
                        
                        <li class="active"><a href="/doc-pm2/ch/runtime/guide/easy-deploy-with-ssh/">Easy Deploy with SSH</a></li>
                        
                    </ul>
                
            
        </li>
    
    
    
        <li class="">
            <a href="/doc-pm2/ch/runtime/production-best-practices/">Best Practices</a>
            
                
            
        </li>
    
    
    
        <li class="">
            <a href="/doc-pm2/ch/runtime/integration/">Integration</a>
            
                
            
        </li>
    
    
    
        <li class="">
            <a href="/doc-pm2/ch/runtime/references/">References</a>
            
                
            
        </li>
    
    </ul>

    </div>
</aside>
          <section class="content">
              <div class="markdown-section gettings_started_block topBlock">
    <p style="display: initial;">Getting started with PM2<span class="runtime_block gettings_started_block_span">Runtime</span><span class="monitoring_block gettings_started_block_span">Monitoring</span><span class="enterprise_block gettings_started_block_span">Enterprise</span></p>
</div>
              <article id="main" class="markdown-section">
                  <div class="edit-page">
  <a rel="noopener" class="edit-page__text" target="_blank" href="http://github.com/keymetrics/doc-pm2/blob/master/_i18n/ch/runtime/guide/easy-deploy-with-ssh.md">Edit Page</a>
</div>
                   <h1 id="easy-deploy-with-ssh">Easy Deploy with SSH</h1>

<p>In many deployment workflow, the routine basically consists of connecting with SSH to multiple servers, git pull the latest version then reload the app.</p>

<p>The pm2 deploy tool purpose is to automate this task.</p>

<p>You set an array of distant hosts, a pre-deploy/post-deploy command line action and you are done.</p>

<hr />

<h2 id="installation">Installation</h2>

<h3 id="ssh-setup">SSH setup</h3>

<p>Be sure that you have the public ssh key on your local machine:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen <span class="nt">-t</span> rsa
ssh-copy-id node@myserver.com
</code></pre></div></div>

<h3 id="ecosystem-file">Ecosystem file</h3>

<p>You first need to configure your ecosystem.config.js with all necessary informations:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">apps</span><span class="p">:</span> <span class="p">[{</span>
    <span class="na">name</span><span class="p">:</span> <span class="s2">"app"</span><span class="p">,</span>
    <span class="na">script</span><span class="p">:</span> <span class="s2">"app.js"</span>
<span class="err"> </span> <span class="p">}],</span>
  <span class="na">deploy</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// "production" is the environment name</span>
    <span class="na">production</span><span class="p">:</span> <span class="p">{</span>
      <span class="c1">// SSH key path, default to $HOME/.ssh</span>
      <span class="na">key</span><span class="p">:</span> <span class="s2">"/path/to/some.pem"</span><span class="p">,</span>
      <span class="c1">// SSH user</span>
      <span class="na">user</span><span class="p">:</span> <span class="s2">"ubuntu"</span><span class="p">,</span>
      <span class="c1">// SSH host</span>
      <span class="na">host</span><span class="p">:</span> <span class="p">[</span><span class="s2">"192.168.0.13"</span><span class="p">],</span>
      <span class="c1">// SSH options with no command-line flag, see 'man ssh' </span>
      <span class="c1">// can be either a single string or an array of strings</span>
      <span class="na">ssh_options</span><span class="p">:</span> <span class="s2">"StrictHostKeyChecking=no"</span><span class="p">,</span>
      <span class="c1">// GIT remote/branch</span>
      <span class="na">ref</span><span class="p">:</span> <span class="s2">"origin/master"</span><span class="p">,</span>
      <span class="c1">// GIT remote</span>
      <span class="na">repo</span><span class="p">:</span> <span class="s2">"git@github.com:Username/repository.git"</span><span class="p">,</span>
      <span class="c1">// path in the server</span>
      <span class="na">path</span><span class="p">:</span> <span class="s2">"/var/www/my-repository"</span><span class="p">,</span>
      <span class="c1">// Pre-setup command or path to a script on your local machine</span>
      <span class="nx">pre</span><span class="o">-</span><span class="na">setup</span><span class="p">:</span> <span class="s2">"apt-get install git ; ls -la"</span><span class="p">,</span>
      <span class="c1">// Post-setup commands or path to a script on the host machine</span>
      <span class="c1">// eg: placing configurations in the shared dir etc</span>
      <span class="nx">post</span><span class="o">-</span><span class="na">setup</span><span class="p">:</span> <span class="s2">"ls -la"</span><span class="p">,</span>
      <span class="c1">// pre-deploy action</span>
      <span class="nx">pre</span><span class="o">-</span><span class="nx">deploy</span><span class="o">-</span><span class="na">local</span><span class="p">:</span> <span class="s2">"echo 'This is a local executed command'"</span>
      <span class="c1">// post-deploy action</span>
      <span class="nx">post</span><span class="o">-</span><span class="na">deploy</span><span class="p">:</span> <span class="s2">"npm install"</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>?&gt; To get more information about the deploy options, check the ecosystem file reference.</p>

<p>?&gt; Note that the distant path must be empty as it will be populated by pm2 deploy.</p>

<h3 id="setup">Setup</h3>

<p>Make your first deploy and populate the distant path with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pm2 deploy production setup
</code></pre></div></div>

<h3 id="deploy">Deploy</h3>

<p>Here are some usefull command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Setup deployment at remote location</span>
pm2 deploy production setup

<span class="c"># Update remote version</span>
pm2 deploy production update

<span class="c"># Revert to -1 deployment</span>
pm2 deploy production revert 1

<span class="c"># execute a command on remote servers</span>
pm2 deploy production <span class="nb">exec</span> <span class="s2">"pm2 reload all"</span>
</code></pre></div></div>

<hr />

<h2 id="deployment-options">Deployment options</h2>

<p>Display deploy help via <code class="highlighter-rouge">pm2 deploy help</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pm2 deploy &lt;configuration_file&gt; &lt;environment&gt; &lt;command&gt;

  Commands:
    setup                run remote setup commands
    update               update deploy to the latest release
    revert [n]           revert to [n]th last deployment or 1
    curr[ent]            output current release commit
    prev[ious]           output previous release commit
    exec|run &lt;cmd&gt;       execute the given &lt;cmd&gt;
    list                 list previous deploy commits
    [ref]                deploy to [ref], the "ref" setting, or latest tag
</code></pre></div></div>

<hr />

<h2 id="force-deployment">Force deployment</h2>

<p>You may get this message:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--&gt; Deploying to dev environment
--&gt; on host 192.168.1.XX

  push your changes before deploying

Deploy failed
</code></pre></div></div>

<p>That means that you have changes in your local system that aren’t pushed inside your git repository, and since the deploy script get the update via <code class="highlighter-rouge">git pull</code> they will not be on your server.
If you want to deploy without pushing any data, you can append the <code class="highlighter-rouge">--force</code> option:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pm2 deploy ecosystem.json production <span class="nt">--force</span>
</code></pre></div></div>

<hr />

<h2 id="considerations">Considerations</h2>

<ul>
  <li>
    <p>You can use the option <code class="highlighter-rouge">--force</code> to skip local change detection</p>
  </li>
  <li>
    <p>Verify that your remote server has the permission to git clone the repository</p>
  </li>
  <li>
    <p>You can declare specific environment variables depending on the environment you want to deploy the code to. For instance to declare variables for the production environment, add “env_production”: {} and declare the variables.</p>
  </li>
  <li>
    <p>You can embed the “apps” &amp; “deploy” section in the package.json</p>
  </li>
</ul>

<hr />

<h2 id="ssh-clone-errors">SSH clone errors</h2>

<p>In most cases, these errors will be caused by <code class="highlighter-rouge">pm2</code> not having the correct keys to clone your repository. You need to verify at every step that the keys are available.</p>

<p><strong>Step 1</strong>
If you are certain your keys are correctly working, first try running <code class="highlighter-rouge">git clone your_repo.git</code> on the target server. If it succeeds, move onto the next steps. If it failed, make sure your keys are stored both on the server and on your git account.</p>

<p><strong>Step 2</strong>
By default <code class="highlighter-rouge">ssh-copy-id</code> copies the default identiy, usually named <code class="highlighter-rouge">id_rsa</code>. If that is not the appropriate key:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-copy-id <span class="nt">-i</span> path/to/my/key your_username@server.com
</code></pre></div></div>
<p>This adds your public key to the <code class="highlighter-rouge">~/.ssh/authorized_keys</code> file.</p>

<p><strong>Step 3</strong>
If you get the following error:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--&gt; Deploying to production environment
--&gt; on host mysite.com
  ○ hook pre-setup
  ○ running setup
  ○ cloning git@github.com:user/repo.git
Cloning into '/var/www/app/source'...
Permission denied (publickey).
fatal: Could not read from remote repository.

Please make sure you have the correct access rights and that the repository exists.

**Failed to clone**

Deploy failed
</code></pre></div></div>
<p>…you may want to create a ssh config file. This is a sure way to ensure that the correct ssh keys are used for any given repository you’re trying to clone. See <a href="https://gist.github.com/Protosac/c3fb459b1a942f161f23556f61a67d66">this example</a>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/.ssh/config
Host alias
    HostName myserver.com
    User username
    IdentityFile ~/.ssh/mykey
# Usage: `ssh alias` 
# Alternative: `ssh -i ~/.ssh/mykey username@myserver.com`

Host deployment
    HostName github.com
    User username
    IdentityFile ~/.ssh/github_rsa
# Usage:
# git@deployment:username/anyrepo.git 
# This is for cloning any repo that uses that IdentityFile. This is a good way to make sure that your remote cloning commands use the appropriate key
</code></pre></div></div>

<hr />

<h2 id="windows-consideration">Windows Consideration</h2>

<p>To run the deploy script under Windows, you need to use a unix shell like bash, so we recommend to install either <a href="https://git-scm.com/download/win">Git bash</a>, <a href="http://babun.github.io/">Babun</a> or  <a href="https://cygwin.com/install.html">Cygwin</a></p>

<hr />

<h2 id="contributing">Contributing</h2>

<p>This tool is a separate module of pm2. You can contribute to it <a href="https://github.com/Unitech/pm2-deploy&quot;&gt;https://github.com/Unitech/pm2-deploy">here</a>.</p>

<hr />

<h2 id="questions-">Questions ?</h2>

<p>We are always happy to help with questions you might have. Search our documentation or check out answers to common questions. You can also post questions or comments to our community forum.</p>


              </article>
              <footer class="markdown-section copyright">
    <p>© 2018 Keymetrics</p>
    <ul id="footer">
        <li><a href="javascript:void(0);">Terms of Use</a></li>
        <li><a href="javascript:void(0);">Privacy Policy</a></li>

        <!-- Adds links to other languages on the post -->
        
          
            
              <li><p class="footer-list">Language: <a href="/doc-pm2/runtime/guide/easy-deploy-with-ssh/" >English</a></p></li>
            

            

            

          
        
          
        
    </ul>
  </footer>



          </section>

      </main>
  </body>
  <script src="https://unpkg.com/clipboard@2.0.0/dist/clipboard.min.js" type="text/javascript"></script>
  <script src="https://unpkg.com/prismjs@1.13.0/prism.js" type="text/javascript"></script>
  <script src="https://unpkg.com/prismjs/components/prism-bash.min.js" type="text/javascript"></script>
  <script src="https://unpkg.com/prismjs/components/prism-markdown.min.js" type="text/javascript"></script>
  <script src="https://unpkg.com/prismjs/components/prism-nginx.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.10.0/js/md5.min.js" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="/doc-pm2/assets/js/prism-clipboard.js" type="text/javascript"></script>
  <!-- <script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script> -->
  <!-- <script src="/doc-pm2/assets/js/gittalk.js"></script> -->
  <script src="/doc-pm2/assets/js/keymetrics-plugins.js" type="text/javascript"></script>
  <script src="/doc-pm2/assets/js/additional.js" type="text/javascript"></script>
</html>

