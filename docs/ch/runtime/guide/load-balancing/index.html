<!DOCTYPE html>

<html class="runtime-page">

  <head>
    <meta charset="UTF-8">
    <title>Document</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="Description">
    <!-- <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96"> -->
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link href="/doc-pm2/assets/img/favicon-96x96.png" rel="icon" sizes="96x96" type="image/png">
    <link rel=“prefetch” href="https://fonts.googleapis.com/css?family=Roboto:400,500">
    <link rel="stylesheet" href="/doc-pm2/assets/css/styles.css">
    <link rel="stylesheet" href="/doc-pm2/assets/css/normalize.css">
    <link rel="stylesheet" href="/doc-pm2/assets/css/bundle.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css">
    <link rel="stylesheet" href="//unpkg.com/gitalk/dist/gitalk.css">
</head>
  <body class="test ready sticky">
      <div class="section header-section">
    <div class=" header-container">
        <div class="PM2_logo_wrapper">
            <a class="logo-container link">
                <div class="PM2_logo"></div>
            </a>
        </div>
        <div class="PM2_search search-wrapper">
            <span class="algolia-autocomplete" style="position: relative; display: inline-block; direction: ltr;"><input class="search_input ds-input" placeholder="Search documentation..." autocomplete="off" spellcheck="false" role="combobox" aria-autocomplete="list" aria-expanded="false" aria-owns="algolia-autocomplete-listbox-0" dir="auto" style="position: relative; vertical-align: top;"><pre aria-hidden="true" style="position: absolute; visibility: hidden; white-space: pre; font-family: Saira, sans-serif; font-size: 18px; font-style: normal; font-variant: normal; font-weight: 400; word-spacing: 0px; letter-spacing: normal; text-indent: 0px; text-rendering: auto; text-transform: none;"></pre><span class="ds-dropdown-menu" role="listbox" id="algolia-autocomplete-listbox-0" style="position: absolute; top: 100%; z-index: 100; display: none; left: 0px; right: auto;"><div class="ds-dataset-1"></div></span></span>
            <div class="PM2_search_icon"><i class="fas fa-search"></i></div>
            <div id="hits" class="algolia-results">
                <!-- Hits widget will appear here -->
            </div>
        </div>
    </div>
</div>
      <main>
          <aside class="sidebar">
    <div class="sidebar_2_wrapper">
        <div class="sidebar_2">
            <a href="/doc-pm2/ch/runtime/overview" data-page="runtime-page">
                <div class="sidebar_2_item sidebar_2_item_runtime">
                    <img class="sidebar_2_item__image" src="/doc-pm2/assets/static/pm2-logo-r.png">
                    <div class="sidebar_2_item__text">Runtime</div>
                </div>
            </a>
            <a href="/doc-pm2/ch/monitoring/overview" data-page="monitoring-page">
                <div class="sidebar_2_item sidebar_2_item_monitoring">
                    <img class="sidebar_2_item__image" src="/doc-pm2/assets/static/pm2-logo-m.png">
                    <div class="sidebar_2_item__text">Monitoring</div>
                </div>
            </a>
            <a href="/doc-pm2/ch/enterprise/overview" data-page="enterprise-page">
                <div class="sidebar_2_item sidebar_2_item_enterprise">
                    <img class="sidebar_2_item__image" src="/doc-pm2/assets/static/pm2-logo-e.png">
                    <div class="sidebar_2_item__text">Enterprise</div>
                </div>
            </a>
        </div>
        <div class="main_content">
        </div>
    </div>
    <div class="sidebar-nav">

    <ul id="acc">
    
    
    
    
        <li class="">
            <a href="/doc-pm2/ch/runtime/overview/">Overview</a>
            
        </li>
    
    
    
        <li class="">
            <a href="/doc-pm2/ch/runtime/quick-start/">Quick Start</a>
            
        </li>
    
    
    
        <li class="active">
            <a href="/doc-pm2/ch/runtime/guide/">Guide</a>
            
                
                    <ul>
                        
                        
                        <li class=""><a href="/doc-pm2/ch/runtime/guide/installation/">Installation</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/ch/runtime/guide/ecosystem-file/">Ecosystem File</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/ch/runtime/guide/process-management/">Process Management</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/ch/runtime/guide/log-management/">Log Management</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/ch/runtime/guide/startup-hook/">Startup Hook</a></li>
                        
                        
                        <li class="active"><a href="/doc-pm2/ch/runtime/guide/load-balancing/">Load-Balancing (cluster mode)</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/ch/runtime/guide/development-tools/">Development Tools</a></li>
                        
                        
                        <li class=""><a href="/doc-pm2/ch/runtime/guide/easy-deploy-with-ssh/">Easy Deploy with SSH</a></li>
                        
                    </ul>
                
            
        </li>
    
    
    
        <li class="">
            <a href="/doc-pm2/ch/runtime/production-best-practices/">Best Practices</a>
            
                
            
        </li>
    
    
    
        <li class="">
            <a href="/doc-pm2/ch/runtime/integration/">Integration</a>
            
                
            
        </li>
    
    
    
        <li class="">
            <a href="/doc-pm2/ch/runtime/references/">References</a>
            
                
            
        </li>
    
    </ul>

    </div>
</aside>
          <section class="content">
              <div class="markdown-section gettings_started_block topBlock">
    <p style="display: initial;">Getting started with PM2<span class="runtime_block gettings_started_block_span">Runtime</span><span class="monitoring_block gettings_started_block_span">Monitoring</span><span class="enterprise_block gettings_started_block_span">Enterprise</span></p>
</div>
              <article id="main" class="markdown-section">
                  <div class="edit-page">
  <a rel="noopener" class="edit-page__text" target="_blank" href="http://github.com/keymetrics/doc-pm2/blob/master/_i18n/ch/runtime/guide/load-balancing.md">Edit Page</a>
</div>
                   
<h1 id="load-balancing-cluster-mode-负载平衡群集模式">Load-Balancing (cluster mode) 负载平衡（群集模式）</h1>

<p>The built-in load-balancer provides networked Node.js applications (http(s)/tcp/udp server) to be scaled accross all CPUs available, without any code modifications.
此内部负载平衡提供在线node.js应用运行在所有可行CPU内，不需要任何代码更改。</p>

<p><img src="http://i.imgur.com/kTAowsL.png" alt="http://i.imgur.com/kTAowsL.png" /></p>

<hr />

<h2 id="usage-运用">Usage 运用</h2>

<p>To enable the cluster mode, just pass the <code class="highlighter-rouge">-i &lt;number-instances&gt;</code> option:
用此选项来激活群集模式 <code class="highlighter-rouge">-i &lt;number-instances&gt;</code>：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pm2 start app.js <span class="nt">-i</span> max
</code></pre></div></div>

<p><code class="highlighter-rouge">max</code> means that PM2 will auto detect the number of available CPUs and run as many processes as possible
<code class="highlighter-rouge">max</code>表示PM2将自动检测可用CPU的数量并尽可能多地运行进程。</p>

<p>Or via your ecosystem file (ecosystem.config.js): 或通过您的生态系统文件 (ecosystem.config.js)：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">apps</span><span class="p">:</span> <span class="p">[{</span>
    <span class="na">script</span><span class="p">:</span> <span class="s2">"app.js"</span><span class="p">,</span>
    <span class="na">instances</span><span class="p">:</span> <span class="s2">"max"</span><span class="p">,</span>
  <span class="p">}]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <em>instances</em> option can be: 
此 <em>instances</em> 选项可作为：</p>
<ul>
  <li>an Integer. This spreads the app across a specific number of clusters.</li>
  <li>the String ‘max’. This spreads the app across all CPU cores.</li>
  <li>一个整数。 这会在特定数量的群集中展开应用。</li>
  <li>字符串’最大’。 这将应用分散到所有CPU内核中。</li>
</ul>

<p>?&gt; You can also use a negative integer. If 4 cores, <code class="highlighter-rouge">pm2 start -i -1</code> will spread 3 clusters (max - integer).
您也可以使用负整数。 如果4个核心，<code class="highlighter-rouge">pm2 start -i -1</code> 将传播3个群集（最大整数）。</p>

<hr />

<h2 id="stateless-application-无状态应用">Stateless Application 无状态应用</h2>

<p>In the context of clustering, you first need to be sure that your application has no internal state.
在群集环境中，您首先需要确定您的应用没有内部状态。</p>

<p>An internal state is typically some local data stored into its processes. It can be an array of websocket connections or a local session-memory for example. Use Redis or other databases instead to share the states between processes.
内部状态通常是存储在其进程中的一些本地数据。 例如，它可以是一组websocket连接或本地会话内存。 改用Redis或其他数据库来共享进程间的状态。</p>

<p>Follow our <a href="runtime/production-best-practices/stateless-application.md">tutorial</a> to make your app stateless.
查看我们的 <a href="runtime/production-best-practices/stateless-application.md">教程</a>，建立您的无状态应用。</p>

<hr />

<h2 id="0-second-downtime-reload-0秒宕机重载">0 second downtime reload 0秒宕机重载</h2>

<p>When you use <code class="highlighter-rouge">restart</code>, pm2 kills and restarts the process so there is a short period of time during which the service is unavailable.
当您使用 <code class="highlighter-rouge">restart</code>时，pm2杀死并重启该进程，所以在短时间内您将无法使用该服务。</p>

<p>With reload, pm2 restarts all instances one by one always kepping at least one process running:
通过重载，pm2会重启所有进程，并始终保持至少一个进程正在运行：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pm2 reload &lt;app_name&gt;
</code></pre></div></div>

<p>Or: 或：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pm2 reload ecosystem.config.js
pm2 reload ecosystem.config.js <span class="nt">--only</span> app
</code></pre></div></div>

<p>If the reload system hasn’t managed to reload your application, a timeout will fallback to a classic restart.
如果重装系统没有重载应用，超时将回退到经典重启。</p>

<hr />

<h2 id="graceful-start--shutdown-正常开机关机">Graceful Start &amp; Shutdown 正常开机&amp;关机</h2>

<p>To be sure that all requests are properly handled in a reload, you need to be sure that your application shutdown, not leaving unanswered requests.
为了确保所有请求都能在重载中被正确处理，您需要确保您的应用关闭，不留下未答复的请求。</p>

<p>A graceful shutdown makes sure to handle all remaining queries before exiting the application and closes all external connections.
正常关机确保在退出应用并关闭所有外部连接之前处理所有剩余的查询。</p>

<p>Get help to setup graceful shutdown with our <a href="runtime/production-best-practices/graceful.md">tutorial</a>.
通过我们的<a href="runtime/production-best-practices/graceful.md">教程</a>获得帮助，设置正常关机。</p>

<hr />

<h2 id="cluster-environment-variable-群集环境变量">Cluster environment variable 群集环境变量</h2>

<p>The <code class="highlighter-rouge">NODE_APP_INSTANCE</code> environment variable is used to make a difference between cluster.
<code class="highlighter-rouge">NODE_APP_INSTANCE</code>环境变量用于区分群集。</p>

<p>For example, if you want to run a cronjob only on one cluster, you can check if <code class="highlighter-rouge">process.env.NODE_APP_INSTANCE === 0</code>. 
例如，如果您只想在一个群集上运行cronjob，可检查 <code class="highlighter-rouge">process.env.NODE_APP_INSTANCE === 0</code>。</p>

<p>This variable can be renamed in the ecosystem file: 
该变量可在生态系统文件中重命名：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">apps</span><span class="p">:</span> <span class="p">[{</span>
    <span class="na">name</span><span class="p">:</span> <span class="s2">"app"</span><span class="p">,</span>
    <span class="na">script</span><span class="p">:</span> <span class="s2">"./app.js"</span><span class="p">,</span>
    <span class="na">instance_var</span><span class="p">:</span> <span class="s2">"INSTANCE_ID"</span><span class="p">,</span>
  <span class="p">}]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>?&gt; This is useful with the <code class="highlighter-rouge">node-config</code> package where name conflicts have been reported, check the <a href="https://github.com/Unitech/pm2/issues/2045">issue</a>. 
这对报告名称冲突的 <code class="highlighter-rouge">node-config</code>软件包非常有用，查看此<a href="https://github.com/Unitech/pm2/issues/2045">问题</a>。</p>

<hr />

<h2 id="next-steps-下一步">Next steps 下一步</h2>

<p><a href="runtime/guide/dev.md">Development tools</a>
<a href="runtime/guide/dev.md">开发工具</a></p>

<hr />

<h2 id="questions--问题">Questions ? 问题？</h2>

<p>We are always happy to help with questions you might have. Search our documentation or check out answers to common questions. You can also post questions or comments to our community forum.
我们永远乐于帮您解决可能遇到的问题。搜索我们的文档或查看常见问题的答案。您也可以在我们的社区论坛发布问题或评论。</p>


              </article>
              <footer class="markdown-section copyright">
    <p>© 2018 Keymetrics</p>
    <ul id="footer">
        <li><a href="javascript:void(0);">Terms of Use</a></li>
        <li><a href="javascript:void(0);">Privacy Policy</a></li>

        <!-- Adds links to other languages on the post -->
        
          
            
              <li><p class="footer-list">Language: <a href="/doc-pm2/runtime/guide/load-balancing/" >English</a></p></li>
            

            

            

          
        
          
        
    </ul>
  </footer>



          </section>

      </main>
  </body>
  <script src="https://unpkg.com/clipboard@2.0.0/dist/clipboard.min.js" type="text/javascript"></script>
  <script src="https://unpkg.com/prismjs@1.13.0/prism.js" type="text/javascript"></script>
  <script src="https://unpkg.com/prismjs/components/prism-bash.min.js" type="text/javascript"></script>
  <script src="https://unpkg.com/prismjs/components/prism-markdown.min.js" type="text/javascript"></script>
  <script src="https://unpkg.com/prismjs/components/prism-nginx.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.10.0/js/md5.min.js" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="/doc-pm2/assets/js/prism-clipboard.js" type="text/javascript"></script>
  <!-- <script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script> -->
  <!-- <script src="/doc-pm2/assets/js/gittalk.js"></script> -->
  <script src="/doc-pm2/assets/js/keymetrics-plugins.js" type="text/javascript"></script>
  <script src="/doc-pm2/assets/js/additional.js" type="text/javascript"></script>
</html>

