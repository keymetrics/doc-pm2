

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="Description">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <!-- <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script> -->
    <link rel="stylesheet" href="https://unpkg.com/docsify/lib/themes/vue.css">
    <link rel="stylesheet" href="https://unpkg.com/docsify-copy-code/styles.css">
    <link rel=“prefetch” href="https://fonts.googleapis.com/css?family=Roboto:400,500">
    <link rel="stylesheet" href="/assets/css/normalize.css">
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="stylesheet" href="/assets/css/bundle.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
    <link rel="stylesheet" href="//unpkg.com/gitalk/dist/gitalk.css">
</head>

<body class="ready sticky">

    <template id="sidebar2-template">
    <div class="sidebar_2_wrapper">
        <div class="sidebar_2">
            <a href="/runtime/overview" data-page="runtime-page">
                <div class="sidebar_2_item sidebar_2_item_runtime">
                    <img class="sidebar_2_item__image" src="/assets/static/pm2-logo-r.png">
                    <div class="sidebar_2_item__text">Runtime</div>
                </div>
            </a>
            <a href="/monitoring/overview" data-page="monitoring-page">
                <div class="sidebar_2_item sidebar_2_item_monitoring">
                    <img class="sidebar_2_item__image" src="/assets/static/pm2-logo-m.png">
                    <div class="sidebar_2_item__text">Monitoring</div>
                </div>
            </a>
            <a href="/enterprise/overview" data-page="enterprise-page">
                <div class="sidebar_2_item sidebar_2_item_enterprise">
                    <img class="sidebar_2_item__image" src="/assets/static/pm2-logo-e.png">
                    <div class="sidebar_2_item__text">Enterprise</div>
                </div>
            </a>
        </div>
        <div class="main_content">
        </div>
    </div>
</template>
<div class="footer-fixed-box"></div>
<div class="section header-section">
    <div class=" header-container">
        <div class="PM2_logo_wrapper">
            <a class="logo-container link">
                <div class="PM2_logo"></div>
            </a>
        </div>
        <div class="PM2_search search-wrapper">
            <span class="algolia-autocomplete" style="position: relative; display: inline-block; direction: ltr;"><input class="search_input ds-input" placeholder="Search documentation..." autocomplete="off" spellcheck="false" role="combobox" aria-autocomplete="list" aria-expanded="false" aria-owns="algolia-autocomplete-listbox-0" dir="auto" style="position: relative; vertical-align: top;"><pre aria-hidden="true" style="position: absolute; visibility: hidden; white-space: pre; font-family: Blender, sans-serif; font-size: 18px; font-style: normal; font-variant: normal; font-weight: 400; word-spacing: 0px; letter-spacing: normal; text-indent: 0px; text-rendering: auto; text-transform: none;"></pre><span class="ds-dropdown-menu" role="listbox" id="algolia-autocomplete-listbox-0" style="position: absolute; top: 100%; z-index: 100; display: none; left: 0px; right: auto;"><div class="ds-dataset-1"></div></span></span>
            <div class="PM2_search_icon"><i class="fas fa-search"></i></div>
            <div id="hits" class="algolia-results">
                <!-- Hits widget will appear here -->
            </div>
        </div>
    </div>
</div>
<nav class="app-nav no-badge">
    <!--navbar-->
</nav>

    <!-- MAIN-CONTENT AREA -->
    <main>
        <aside class="sidebar">
    <div class="sidebar_2_wrapper">
        <div class="sidebar_2">
            <a href="/runtime/overview" data-page="runtime-page">
                <div class="sidebar_2_item sidebar_2_item_runtime">
                    <img class="sidebar_2_item__image" src="/assets/static/pm2-logo-r.png">
                    <div class="sidebar_2_item__text">Runtime</div>
                </div>
            </a>
            <a href="/monitoring/overview" data-page="monitoring-page">
                <div class="sidebar_2_item sidebar_2_item_monitoring">
                    <img class="sidebar_2_item__image" src="/assets/static/pm2-logo-m.png">
                    <div class="sidebar_2_item__text">Monitoring</div>
                </div>
            </a>
            <a href="/enterprise/overview" data-page="enterprise-page">
                <div class="sidebar_2_item sidebar_2_item_enterprise">
                    <img class="sidebar_2_item__image" src="/assets/static/pm2-logo-e.png">
                    <div class="sidebar_2_item__text">Enterprise</div>
                </div>
            </a>
        <div class="lang-selector">
          <!-- Adds links to other languages on the post -->
          
            
              
                <a href="/runtime/integration/capistrano/" >Language: English</a>
              

              

              

            
          
            
          
        </div>
        </div>
        <div class="main_content">
        </div>
    </div>
    <div class="sidebar-nav">

    <ul id="acc">
    
    
    
    
    
        <li class="">
            <a href="/ch/runtime/overview/">Overview</a>
            
        </li>
    
    
    
    
        <li class="">
            <a href="/ch/runtime/quick-start/">Quick Start</a>
            
        </li>
    
    
    
    
        <li class="">
            <a href="/ch/runtime/guide/">Guide</a>
            
                
            
        </li>
    
    
    
    
        <li class="">
            <a href="/ch/runtime/production-best-practices/">Production Best Practices</a>
            
                
            
        </li>
    
    
    
    
        <li class="active">
            <a href="/ch/runtime/integration/">Integration</a>
            
                
                    <ul>
                        
                        
                        <li class=""><a href="/ch/runtime/integration/elastic-beanstalk/">AWS Elastic Beanstalk</a></li>
                        
                        
                        <li class=""><a href="/ch/runtime/integration/docker/">Docker</a></li>
                        
                        
                        <li class=""><a href="/ch/runtime/integration/heroku/">Heroku</a></li>
                        
                        
                        <li class=""><a href="/ch/runtime/integration/transpilers/">Transpilers</a></li>
                        
                        
                        <li class=""><a href="/ch/runtime/integration/cloud-providers/">With a Cloud Provider</a></li>
                        
                    </ul>
                
            
        </li>
    
    
    
    
        <li class="">
            <a href="/ch/runtime/references/">References</a>
            
                
            
        </li>
    
    </ul>

    </div>
</aside>

        <section class="content">
            <div class="markdown-section gettings_started_block topBlock">
    <p style="display: initial;">Getting started with PM2<span class="runtime_block gettings_started_block_span">Runtime</span><span class="monitoring_block gettings_started_block_span">Monitoring</span><span class="enterprise_block gettings_started_block_span">Enterprise</span></p>
</div>
            <article id="main" class="markdown-section">
                 <p>!&gt; To be finished</p>

<h1 id="using-pm2-with-capistrano">Using PM2 with Capistrano</h1>

<h3 id="the-main-issue">The main issue</h3>

<p>No matter the tools you use to deploy your code, you might get confronted to a <strong>Capistrano</strong>-like structure. 
In general, the method will have a directory tree like this one:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>project_root
├── current -&gt; releases/20150301100000 # this is a symlink to the current release
└── releases
    ├── 20150301100000
    ├── 20150228100000
    └── 20150226100000
</code></pre></div></div>

<p>In most of this kind of deployment, old and no longer used releases get deleted. Indeed, a new release will have the following consequences:</p>

<ol>
  <li>The project is deployed to a new path, here <code class="highlighter-rouge">releases/YYYYMMDDHHMMSS</code></li>
  <li>The <code class="highlighter-rouge">current</code> symlink changes to the new path</li>
  <li>Old releases are deleted.</li>
</ol>

<p>With PM2, you can be tempted to run everything like you usually would, for example:</p>

<ol>
  <li>Do the deployment</li>
  <li>Restart the PM2 script from the freshly deployed directory</li>
</ol>

<p>But wait, there is something wrong with this method. Let’s illustrate with the first to the 11th deployments. In our example, the 1st release will get deleted while we want to keep 10 releases:</p>

<ol>
  <li>Do the first deployment</li>
  <li>From the <code class="highlighter-rouge">current</code> path, start our project <code class="highlighter-rouge">pm2 startOrRestart index.js</code>, the current working directory is <code class="highlighter-rouge">releases/20150301100000</code></li>
  <li>Days are going by</li>
  <li>11th deployment</li>
  <li>The 1st deployment is no longer used, in consequence it gets deleted</li>
  <li><code class="highlighter-rouge">pm2 startOrRestart index.js</code> (or any PM2 command) will fail with error <code class="highlighter-rouge">Error: ENOENT, no such file or directory for process.cwd()</code></li>
</ol>

<p>What has gone wrong then? 
It’s really straightforward: 10 days ago, PM2 was started in the <code class="highlighter-rouge">releases/20150301100000</code> but this one just got removed! 
So, <code class="highlighter-rouge">process.cwd()</code> doesn’t exist anymore. It’s just like running two shells in the same directory, removing it from one shell and trying to run any command in the other shell. 
It will fail and generate this kind of error:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fatal: Unable to read current working directory: No such file or directory.
</code></pre></div></div>

<h3 id="the-solution">The solution</h3>

<p>In my opinion, Capistrano structures are great. They allow you to rollback with nothing more than a symlink change. 
To resolve this issue we just need to start PM2 in a directory that will never get removed.
My proposal here is to define an absolute <code class="highlighter-rouge">project_root</code>. It will store all the necessary tools required to get our application on tracks such as configuration files, logs, data (i.e. sqlite) etc.</p>

<p>The structure should look like this now:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>project_root # in this example absolute path is /home/www/project_root
├── current -&gt; releases/20150301100000 # this is a symlink to the current release
├── releases
|   ├── 20150301100000
|   ├── 20150228100000
|   └── 20150226100000
├── logs # keeping our pm2 logs in here is a good idea so that they stay the same between deployments
└── configuration # Are you comitting your database environments?
</code></pre></div></div>

<p>And, what’s more important than this is to define the PM2 ecosystem to match this structure:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#</span><span class="w"> </span><span class="err">ecosystem.json</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="s2">"apps"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-app"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"script"</span><span class="p">:</span><span class="w"> </span><span class="s2">"./index.js"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"cwd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/home/www/project_root/current"</span><span class="p">,</span><span class="w"> 
    </span><span class="s2">"error_file"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/home/www/project_root/logs/app.err.log"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"out_file"</span><span class="p">:</span><span class="w"> </span><span class="s2">"../logs/app.out.log"</span><span class="p">,</span><span class="w"> </span><span class="err">#this</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">same</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">absolute</span><span class="w"> </span><span class="err">error_file</span><span class="w"> </span><span class="err">path</span><span class="w">
    </span><span class="s2">"exec_mode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fork_mode"</span><span class="w">
  </span><span class="p">}]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><em>You don’t like absolute paths in this configuration? Use the <code class="highlighter-rouge">PWD</code> environement variable instead!</em></p>

<p>Now, the <code class="highlighter-rouge">ecosystem.json</code> is usually inside your project, or repository. To start it properly you’ll have to start PM2 from the <code class="highlighter-rouge">project_root</code> directory:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># somewhere in your deployment script</span>
<span class="nb">cd</span> /home/www/project_root
pm2 startOrRestart current/ecosystem.json
</code></pre></div></div>

<h3 id="logs-and-data-tip">Logs and data tip</h3>

<p>When working in continuous integration world, you’ll rather have the <code class="highlighter-rouge">logs</code> and <code class="highlighter-rouge">data</code> directories inside your repository. This eases the testability and portability of your application. When refering to a Capistrano structure, my suggestion would be to symlink data directories to the parent level.</p>

<p>In this case, the <code class="highlighter-rouge">ecosystem.json</code> can be like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#</span><span class="w"> </span><span class="err">ecosystem.json</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="s2">"apps"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-app"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"script"</span><span class="p">:</span><span class="w"> </span><span class="s2">"./index.js"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"cwd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/home/www/project_root/current"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"error_file"</span><span class="p">:</span><span class="w"> </span><span class="s2">"./logs/app.err.log"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"out_file"</span><span class="p">:</span><span class="w"> </span><span class="s2">"./logs/app.out.log"</span><span class="p">,</span><span class="w"> 
    </span><span class="s2">"exec_mode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fork_mode"</span><span class="w">
  </span><span class="p">}]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>And the static project directory would be:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>project_root 
├── logs 
├── configuration 
|   └── development.yml 
└── data 
    ├── staging.sqlite 
    └── development.sqlite 
</code></pre></div></div>

<p>When deployed, all you have to do is to link <code class="highlighter-rouge">logs</code>, <code class="highlighter-rouge">configuration</code>, <code class="highlighter-rouge">data</code> to the parent directory! 
This way, in a deployed environment of the same project, it’d look a lot like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>project_root 
├── logs -&gt; ../logs
├── configuration  -&gt; ../configuration
└── data -&gt; /home/www/project_root/data # absolute path for the example
</code></pre></div></div>

<p>For more informations, take a look at the <a href="https://github.com/Unitech/pm2/issues/1623">original issue</a>.</p>

<h3 id="shipit-pm2-example">Shipit PM2 example</h3>

<p>This is the task I use with <a href="https://github.com/shipitjs/shipit">shipit</a>. Note that the same command could apply to most of the deployment tools.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">pm2Task</span><span class="p">(</span><span class="nx">gruntOrShipit</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">shipit</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">getShipit</span><span class="p">(</span><span class="nx">gruntOrShipit</span><span class="p">)</span>

  <span class="nx">utils</span><span class="p">.</span><span class="nx">registerTask</span><span class="p">(</span><span class="nx">shipit</span><span class="p">,</span> <span class="s1">'pm2'</span><span class="p">,</span> <span class="nx">task</span><span class="p">)</span>

  <span class="kd">function</span> <span class="nx">task</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">shipit</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Launching pm2'</span><span class="p">)</span> 

    <span class="kd">let</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">shipit</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">pm2</span> <span class="o">&amp;&amp;</span> <span class="nx">shipit</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">pm2</span><span class="p">.</span><span class="nx">script</span> <span class="p">?</span> <span class="nx">shipit</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">pm2</span><span class="p">.</span><span class="nx">script</span> <span class="p">:</span> <span class="s1">'ecosystem.json'</span>

    <span class="kd">let</span> <span class="nx">cmd</span> <span class="o">=</span> <span class="s2">`SOME_APP_ENV="</span><span class="p">${</span><span class="nx">shipit</span><span class="p">.</span><span class="nx">environment</span><span class="p">}</span><span class="s2">" cd </span><span class="p">${</span><span class="nx">shipit</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">deployTo</span><span class="p">}</span><span class="s2"> &amp;&amp; pm2 startOrRestart --env </span><span class="p">${</span><span class="nx">shipit</span><span class="p">.</span><span class="nx">environment</span><span class="p">}</span><span class="s2"> current/</span><span class="p">${</span><span class="nx">schema</span><span class="p">}</span><span class="s2">`</span>

    <span class="k">return</span> <span class="nx">shipit</span><span class="p">.</span><span class="nx">remote</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">shipit</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'cleaned'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">shipit</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="s1">'pm2'</span><span class="p">)</span> 
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In our example, the executed command would result in:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">SOME_APP_ENV</span><span class="o">=</span><span class="s2">"production"</span> <span class="nb">cd</span> /home/www/project_root <span class="o">&amp;&amp;</span> pm2 startOrRestart <span class="nt">--env</span> production current/ecosystem.json<span class="sb">`</span>
</code></pre></div></div>

<p>Note that I’m using <a href="http://pm2.keymetrics.io/docs/usage/application-declaration/#switching-to-different-environments">PM2’s environments ability</a> on top of declaring my own environment variable (<code class="highlighter-rouge">SOME_APP_ENV</code>).</p>


            </article>

        </section>

        
    </main>
</body>
    <script>window.$docsify = {"basePath":"/docs","alias":{"/runtime/.*/_sidebar.md":"/runtime/_sidebar.md","/monitoring/.*/_sidebar.md":"/monitoring/_sidebar.md","/enterprise/.*/_sidebar.md":"/enterprise/_sidebar.md"},"auto2top":true,"coverpage":false,"executeScript":true,"loadSidebar":"_sidebar.md","loadNavbar":false,"mergeNavbar":false,"subMaxLevel":1,"name":"","search":false,"plugins":[],"routerMode":"history"}</script>
<!-- <script src="//unpkg.com/docsify/lib/docsify.min.js"></script> -->
<!-- <script src="/ch/assets/js/docsify.js"></script> -->
<script src="/assets/js/scripts.js" type="text/javascript"></script>
<script src="https://unpkg.com/clipboard@2.0.0/dist/clipboard.min.js" type="text/javascript"></script>
<script src="https://unpkg.com/prismjs@1.13.0/prism.js" type="text/javascript"></script>
<script src="https://unpkg.com/prismjs/components/prism-bash.min.js" type="text/javascript"></script>
<script src="https://unpkg.com/prismjs/components/prism-markdown.min.js" type="text/javascript"></script>
<script src="https://unpkg.com/prismjs/components/prism-nginx.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.10.0/js/md5.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="/assets/js/prism-clipboard.js" type="text/javascript"></script>
<!-- <script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script> -->
<!-- <script src="/ch/assets/js/gittalk.js"></script> -->
<script src="/assets/js/keymetrics-plugins.js" type="text/javascript"></script>
<script src="/assets/js/additional.js" type="text/javascript"></script>
</html>
